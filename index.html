<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamRise | The Future of Streaming</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;400;600;800&display=swap');
        :root { --p-color: #8b5cf6; --s-color: #d946ef; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #030303; color: white; overflow: hidden; }
        .sidebar { background: #080808; width: 280px; border-right: 1px solid rgba(255,255,255,0.05); }
        .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .view-section { display: none; opacity: 0; transform: translateY(10px); transition: all 0.4s ease; }
        .view-section.active { display: block; opacity: 1; transform: translateY(0); }
        .auth-modal { display: none; position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); }
        .auth-modal.active { display: flex; align-items: center; justify-content: center; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #1a1a1a; border-radius: 10px; }
    </style>
</head>
<body class="flex h-screen w-full">

    <div id="auth-modal" class="auth-modal p-4">
        <div class="glass max-w-md w-full p-10 rounded-[40px] text-center">
            <h2 id="auth-title" class="text-3xl font-black italic mb-6 uppercase">Acceso <span class="text-purple-500">Rise</span></h2>
            <div class="space-y-4">
                <input type="email" id="auth-email" placeholder="Email" class="w-full bg-white/5 border border-white/10 rounded-2xl py-3 px-5 focus:outline-none focus:border-purple-500">
                <input type="password" id="auth-password" placeholder="Contraseña" class="w-full bg-white/5 border border-white/10 rounded-2xl py-3 px-5 focus:outline-none focus:border-purple-500">
                <button onclick="handleAuth()" id="auth-btn" class="w-full bg-purple-600 py-3 rounded-2xl font-black text-xs hover:bg-white hover:text-black transition uppercase">Entrar</button>
            </div>
            <p class="mt-6 text-xs text-gray-500 cursor-pointer" onclick="toggleAuthMode()">¿No tienes cuenta? <span class="text-purple-400 font-bold">Regístrate</span></p>
            <button onclick="closeAuth()" class="mt-4 text-[10px] text-gray-600 uppercase font-bold">Cerrar</button>
        </div>
    </div>

    <aside class="sidebar h-full hidden md:flex flex-col shrink-0 z-50">
        <div class="p-6">
            <div class="flex items-center space-x-2 mb-10 cursor-pointer" onclick="showView('home')">
                <div class="w-8 h-8 bg-purple-600 rounded-lg flex items-center justify-center font-black">SR</div>
                <span class="text-xl font-extrabold tracking-tighter italic uppercase">Stream<span class="text-purple-500">Rise</span></span>
            </div>
            <nav class="space-y-1">
                <button onclick="showView('home')" class="w-full flex items-center space-x-3 p-3 rounded-xl hover:bg-white/5 transition text-gray-400">
                    <i class="fa-solid fa-compass"></i> <span class="text-sm font-semibold">Explorar</span>
                </button>
                <button onclick="showView('profile')" class="w-full flex items-center space-x-3 p-3 rounded-xl hover:bg-white/5 transition text-gray-400">
                    <i class="fa-solid fa-user-gear"></i> <span class="text-sm font-semibold">Mi Canal</span>
                </button>
            </nav>
            <div class="mt-12">
                <p class="text-[10px] font-bold text-gray-600 uppercase mb-4 tracking-widest">Gente en Vivo</p>
                <div id="sidebar-streams" class="space-y-4"></div>
            </div>
        </div>
    </aside>

    <main class="flex-grow flex flex-col h-full overflow-hidden relative">
        <nav class="h-20 flex justify-between items-center px-8 bg-[#030303]/80 backdrop-blur-xl border-b border-white/5">
            <div class="relative w-full max-w-xl">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                <input type="text" placeholder="Buscar directos..." class="w-full bg-white/5 border border-white/10 rounded-2xl py-2 pl-12 pr-4 text-sm focus:outline-none">
            </div>
            <div class="flex items-center space-x-4 ml-6">
                <button onclick="showView('profile')" class="bg-white text-black px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-purple-500 transition">Go Live</button>
                <img src="https://i.pravatar.cc/100?u=guest" id="header-avatar" class="w-10 h-10 rounded-xl bg-white/10 cursor-pointer" onclick="showView('profile')">
            </div>
        </nav>

        <div id="scroll-container" class="flex-grow overflow-y-auto p-4 md:p-10">
            
            <section id="home" class="view-section active">
                <h3 class="text-xl font-black italic mb-6 uppercase tracking-tight">Creciente <span class="text-purple-500">Ahora</span></h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8" id="streams-grid"></div>
            </section>

            <section id="stream" class="view-section">
                <div class="max-w-5xl mx-auto">
                    <div class="aspect-video bg-black rounded-[40px] overflow-hidden border border-white/10 shadow-2xl">
                        <iframe id="peertube-player" class="w-full h-full" src="" frameborder="0" allowfullscreen></iframe>
                    </div>
                    <div class="mt-8 flex items-center space-x-6 p-6 glass rounded-[30px]">
                        <img id="streamer-avatar" src="" class="w-16 h-16 rounded-full border-2 border-purple-500">
                        <div>
                            <h2 id="stream-title" class="text-2xl font-black italic">Canal</h2>
                            <p id="streamer-name" class="text-purple-400 font-bold uppercase text-xs"></p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="profile" class="view-section">
                <div class="max-w-xl mx-auto space-y-6">
                    <div id="user-logged-out" class="glass p-12 rounded-[50px] text-center">
                        <h2 class="text-2xl font-black mb-6 italic">Inicia sesión para transmitir</h2>
                        <button onclick="openAuth()" class="bg-purple-600 px-8 py-3 rounded-2xl font-black text-xs uppercase">Login / Registro</button>
                    </div>

                    <div id="user-logged-in" class="hidden space-y-6">
                        <div class="glass p-10 rounded-[50px] text-center">
                            <img id="my-avatar" class="w-24 h-24 rounded-[30px] mx-auto mb-4 border-2 border-purple-500 shadow-xl">
                            <h2 id="my-username" class="text-2xl font-black italic uppercase">Usuario</h2>
                        </div>

                        <div class="glass p-8 rounded-[40px] space-y-4">
                            <h4 class="text-xs font-black uppercase text-gray-500">Configuración de directo</h4>
                            <div>
                                <label class="text-[10px] font-bold text-gray-600 uppercase block mb-2">ID del Video (Ej: de PeerTube)</label>
                                <input type="text" id="video-id-input" placeholder="ID de video..." class="w-full bg-white/5 border border-white/10 rounded-2xl py-3 px-5 focus:outline-none focus:border-purple-500 text-sm">
                            </div>
                            <button onclick="updateMyStream()" class="w-full bg-white text-black py-3 rounded-2xl font-black text-[10px] uppercase hover:bg-purple-500 hover:text-white transition">Actualizar mi Canal</button>
                        </div>

                        <div class="glass p-8 rounded-[40px]">
                            <label class="text-[10px] font-black text-gray-500 uppercase">Tu Clave de Stream (OBS)</label>
                            <div class="bg-black/40 p-3 rounded-xl border border-white/5 mt-2 flex justify-between items-center">
                                <code id="user-stream-key" class="text-purple-400 font-mono text-xs">********</code>
                                <i class="fa-solid fa-copy cursor-pointer text-gray-500 hover:text-white" onclick="copyKey()"></i>
                            </div>
                        </div>
                        <button onclick="signOut()" class="w-full text-red-500 font-bold text-[10px] uppercase tracking-widest">Cerrar Sesión</button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://arlrkjxpkhphkqfduwch.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_aBW7HgaoFNbrw_wwdtQgCw_qG-gMuXl';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let myId = null;

        // AUTH
        async function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) alert(error.message);
            else { closeAuth(); checkUser(); }
        }

        async function checkUser() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (user) {
                myId = user.id;
                const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
                document.getElementById('user-logged-in').classList.remove('hidden');
                document.getElementById('user-logged-out').classList.add('hidden');
                document.getElementById('my-username').innerText = profile.username;
                document.getElementById('user-stream-key').innerText = profile.stream_key;
                document.getElementById('video-id-input').value = profile.last_video_id || '';
                const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.id}`;
                document.getElementById('my-avatar').src = avatarUrl;
                document.getElementById('header-avatar').src = avatarUrl;
            }
        }

        // STREAM LOGIC
        async function updateMyStream() {
            const vid = document.getElementById('video-id-input').value;
            const { error } = await supabaseClient.from('profiles').update({ last_video_id: vid }).eq('id', myId);
            if (error) alert("Error: " + error.message);
            else { alert("¡Perfil actualizado! Estás en vivo."); loadStreams(); }
        }

        async function loadStreams() {
            // Solo cargamos usuarios que tengan un video puesto
            const { data: profiles } = await supabaseClient.from('profiles').select('*').not('last_video_id', 'is', null);
            const grid = document.getElementById('streams-grid');
            const sidebar = document.getElementById('sidebar-streams');
            grid.innerHTML = ''; sidebar.innerHTML = '';

            profiles.forEach(p => {
                const avatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${p.id}`;
                grid.innerHTML += `
                    <div class="glass p-4 rounded-[30px] cursor-pointer hover:border-purple-500 transition" onclick="openStream('${p.username}', '${p.last_video_id}', '${avatar}')">
                        <div class="aspect-video bg-purple-900/20 rounded-2xl mb-4 flex items-center justify-center relative overflow-hidden text-purple-600 font-black">
                             LIVE <img src="https://images.unsplash.com/photo-1614850523296-d8c1af93d400?q=80&w=400" class="absolute inset-0 opacity-10 object-cover">
                        </div>
                        <div class="flex items-center space-x-3">
                            <img src="${avatar}" class="w-10 h-10 rounded-full bg-white/5">
                            <div>
                                <h4 class="text-sm font-black italic uppercase">${p.username}</h4>
                                <p class="text-[10px] text-gray-500 font-bold tracking-widest">TRANSMITIENDO</p>
                            </div>
                        </div>
                    </div>`;
                sidebar.innerHTML += `
                    <div class="flex items-center space-x-3 p-1 cursor-pointer hover:text-purple-500" onclick="openStream('${p.username}', '${p.last_video_id}', '${avatar}')">
                        <img src="${avatar}" class="w-6 h-6 rounded-full">
                        <span class="text-[11px] font-bold uppercase">${p.username}</span>
                    </div>`;
            });
        }

        function openStream(user, vid, avatar) {
            document.getElementById('stream-title').innerText = "Streaming de " + user;
            document.getElementById('streamer-name').innerText = "@" + user;
            document.getElementById('streamer-avatar').src = avatar;
            document.getElementById('peertube-player').src = `https://peertube2.cpy.re/videos/embed/${vid}?autoplay=1`;
            showView('stream');
        }

        function showView(id) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function openAuth() { document.getElementById('auth-modal').classList.add('active'); }
        function closeAuth() { document.getElementById('auth-modal').classList.remove('active'); }
        async function signOut() { await supabaseClient.auth.signOut(); window.location.reload(); }
        function copyKey() { navigator.clipboard.writeText(document.getElementById('user-stream-key').innerText); alert("Clave copiada!"); }

        window.onload = () => { checkUser(); loadStreams(); };
    </script>
</body>
</html>
